<!DOCTYPE html>
<html>
<head>
  <title>Google Drive Gallery</title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.2/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-Zenh87qX5JnK2Jl0vWa8Ck2rdkQ2Bzep5IDxbcnCeuOxjzrPF/et3URy9Bv1WTRi" crossorigin="anonymous">

  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.3.0/font/bootstrap-icons.css">

  <style>
      @media screen {
          .main-container {
              width: 60%;
              /* border-radius: 0.5%; */
              padding: 5px;
              margin-top: 5px;
          }
      }
  </style>

  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
  
  <script type="text/javascript">
    window.onerror = function(error) {
      alert("window error..." + error + "\n" + error.stack);
    }
  </script>

  <script type="text/javascript">
    const CACHE_DEBUG_MODE = "debugMode";

    // Quick start: https://developers.google.com/drive/api/quickstart/js
    // File list: https://developers.google.com/drive/api/v3/reference/files/list
    
    const CLIENT_ID="1015092151085-osb88kjq9jtmve4hv2bisa0ugda4iun0.apps.googleusercontent.com";
    const API_KEY="AIzaSyC-AjutFl4UADerP1ybHDY3CGvHyUnJKSA";
    //const API_KEY="AIzaSyCKIA6PZIy_6Y92eISUn7XyIFk_DxRFBEQ";

    // Discovery doc URL for APIs used by the quickstart
    const DISCOVERY_DOC = 'https://www.googleapis.com/discovery/v1/apis/drive/v3/rest';

    // Authorization scopes required by the API; multiple scopes can be included, separated by spaces.
    const SCOPES = 'https://www.googleapis.com/auth/drive.metadata.readonly';

    let tokenClient;
    let gapiInited = false;
    let gisInited = false;
    let albumId = "1eHo-uOU1LTHQKFJhhd8BpMwiF81NTYmk";
    let nextPageToken = ""; // token for pagination
    let pageSize = 20;
    let fileFields = [
      'id',
      'name',
      'mimeType',
      'createdTime',
      'modifiedTime',
      'size',
      'hasThumbnail',
      'webViewLink',
      'imageMediaMetadata(time,width,height,cameraMake,cameraModel,exposureTime,isoSpeed,whiteBalance)'
    ].join(",");

    /**
     * Callback after api.js is loaded.
     */
    function gapiLoaded() {
      gapi.load('client', initializeGapiClient);
    }

    /**
     * Callback after the API client is loaded. Loads the
     * discovery doc to initialize the API.
     */
    async function initializeGapiClient() {
      await gapi.client.init({
        apiKey: API_KEY,
        discoveryDocs: [DISCOVERY_DOC],
      });
      gapiInited = true;
      initUi();
    }

    /**
     * Callback after Google Identity Services are loaded.
     */
    function gisLoaded() {
      tokenClient = google.accounts.oauth2.initTokenClient({
        client_id: CLIENT_ID,
        scope: SCOPES,
        callback: '', // defined later
      });
      gisInited = true;
      initUi();
    }

    function initUi() {
      if (!gapiInited || !gisInited) {
        return; // not ready
      }

      $('#debugMode').prop(
        'checked',
        localStorage.getItem(CACHE_DEBUG_MODE) === 'true'
      );

      // register listener to load more images when scrolling to bottom
      $(document.body).on('touchmove', onScroll); // for mobile
      $(window).on('scroll', onScroll);

      // trigger selection by default album
      $(".album-menu:first").click();
    }

    function onScroll() {
      if ($(window).scrollTop() + window.innerHeight >= document.body.scrollHeight) {
      // if ($(window).scrollTop() + $(window).height() == $(document).height()) {
        debugAlert("scrolled to bottom");
        await listFiles();
      }
    }

    /**
     *  Sign in the user upon button click.
     */
    function switchAccount() {
      try {
        signOut();

        tokenClient.callback = async (resp) => {
          if (resp.error !== undefined) {
            throw (resp);
          }
          await listFiles();
        };

        if (gapi.client.getToken() === null) {
          // Prompt the user to select a Google Account and ask for consent to share their data
          // when establishing a new session.
          tokenClient.requestAccessToken({prompt: 'consent'});
        } else {
          // Skip display of account chooser and consent dialog for an existing session.
          tokenClient.requestAccessToken({prompt: ''});
        }
      } catch (err) {
        handleError(err);
      }
    }

    function signOut() {
      const token = gapi.client.getToken();
      if (token !== null) {
        google.accounts.oauth2.revoke(token.access_token);
        gapi.client.setToken('');
      }
    }

    async function switchAlbum(id) {
      albumId = id;
      nextPageToken = "";

      let name = await getAlbumName(id);
      $("#albumName").html(name);

      // reload from new album 
      $('#fileListContainer').html('');
      listFiles();
    }

    async function listFiles() {
      hideError();
      hideInfo();

      try {
        let files = await getFileList();

        if (files.length == 0) {
          showInfo('No data');
          return;
        }

        let container = $('#fileListContainer');
        files.forEach((file) => container.append(toFileCellHtml(file)));
      } catch (err) {
        handleError(err);
      }
    }

    async function getFileList() {
      let criteria = " and createdTime > '2022-08-01T12:00:00'";

      // default fields: id, name, and mimeType
      let response = await gapi.client.drive.files.list({
        q: `'${albumId}' in parents ${criteria}`, // link ID
        fields: `nextPageToken, files(${fileFields})`,
        pageSize: pageSize,
        orderBy: "name",
        pageToken: nextPageToken || "",
      });

      debugAlert(response);

      nextPageToken = response.result.nextPageToken;

      return response.result.files.map((file) => $.extend(file, {
        thumbnailLink: getThumbnailLink(file.id),
        isImage: function() {
          return this.mimeType.includes("image");
        },
        getExifTime: function() {
          return this.imageMediaMetadata ? this.imageMediaMetadata.time : "";
        }
      }));
    }

    async function getAlbumName(id) {
      try {
        let response = await gapi.client.drive.files.get({ fileId: id });
        return response.result.name;
      } catch (err) {
        handleError(err);
      }
    }

    function getThumbnailLink(id) {
      return "https://drive.google.com/thumbnail?authuser=0&sz=w320&id=" + id;
    }

    function toFileCellHtml(file) {
      let datetime = file.isImage() ? file.getExifTime() : new Date(file.createdTime).toLocaleString();

      return `<figure class="figure">
      <img src="${file.thumbnailLink}" class="figure-img img-fluid rounded" alt="${file.name}"
       data-bs-toggle="modal" data-bs-target="#photoFrame"
       onclick="showPhoto('${file.id}', ${file.thumbnailLink})"/>
      <figcaption class="figure-caption text-end">${datetime}</figcaption></figure>`;
    }

    function showPhoto(id, thumbnailLink) {
      $('#photoFrame .modal-body img').attr("src", thumbnailLink);
      $('#photoFrame .modal-body .download-link').attr("href", `https://drive.google.com/uc?export=download&id=${id}`);
      //$('#photoFrame .modal-body img').attr("src", `https://drive.google.com/uc?export=view&id=${id}`);
    }

    function handleError(err) {
      try {
        showError(JSON.stringify(err) + "<br/>");
      } catch (err) {
        showError(err.message);
      }
    }

    function showInfo(message) {
      $('#info').html(message);
      $('#info').show();
    }

    function hideInfo() {
      $('#info').hide();
    }

    function showError(message) {
      $('#error').html(message);
      $('#error').show();
    }

    function hideError() {
      $('#error').hide();
    }

    function debugAlert(message) {
      if (!isDebugModeEnabled()) {
        return; // debug mode is disabled
      }

      try {
        alert(typeof message === "string" ? message : JSON.stringify(message));
      } catch (err) {
        alert("Not able to parse message: " + message);
      }
    }

    function storeDebugMode() {
      localStorage.setItem(CACHE_DEBUG_MODE, isDebugModeEnabled());
    }
    
    function isDebugModeEnabled() {
      return $('#debugMode').is(':checked');
    }
  </script>
</head>
<body>
  <div class="container text-center">
    <button id="btnSwitchAccount" class="btn btn-primary" onclick="switchAccount()">
      <i class="bi bi-person-x-fill"></i>
    </button>
    <input id="debugMode" type="checkbox" onchange="storeDebugMode()" onchange="storeDebugMode">Debug

    <div id="info" class="alert alert-info" role="alert" hidden></div>
    <div id="error" class="alert alert-danger" role="alert" hidden></div>
  </div>
  
  <div class="container">
    <div class="dropdown">
      <button id="albumMenu" class="btn btn-secondary dropdown-toggle" type="button"
              data-bs-toggle="dropdown" aria-expanded="false">
        <i class="bi bi-journal-album"></i>
      </button>
      <ul class="dropdown-menu" aria-labelledby="albumMenu">
        <li>
          <a class="dropdown-item album-menu" href="#" onclick="switchAlbum('1ytzgYQc_SBp-PRTmbwb24PXJ9pWRMHL5')">
          20221015-yokohama-yosakoi
          </a>
        </li>
        <li>
          <a class="dropdown-item album-menu" href="#" onclick="switchAlbum('1yrIXKE-5XKQOe7_pmLduVFynqpk_z68i')">
          20221016-yokohama-yosakoi
          </a>
        </li>
        <li>
          <a class="dropdown-item album-menu" href="#" onclick="switchAlbum('1eHo-uOU1LTHQKFJhhd8BpMwiF81NTYmk')">
          20221008-tokyo-yosakoi
          </a>
        </li>
        <li>
          <a class="dropdown-item album-menu" href="#" onclick="switchAlbum('1yrx_QkJ14QCjcHYYoO1p_8CdZRVOpPPT')">
          20221009-tokyo-yosakoi
          </a>
        </li>
      </ul>
    </div>

    <nav aria-label="breadcrumb">
      <ol class="breadcrumb">
        <li class="breadcrumb-item active" aria-current="page">
          <span id="albumName"></span>
        </li>
      </ol>
    </nav>
  </div>
  
  <div class="container text-center">
    <div id="fileListContainer" class="row row-cols-2">
    </div>
  </div>

  <!-- Modal -->
  <div class="modal fade" id="photoFrame" tabindex="-1" aria-labelledby="photoFrameLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
      <div class="modal-content">
        <div class="modal-body">
          <img class="img-fluid" src="" alt="" /></a>
          <div class="fixed-bottom">
            <a href="" class="download-link" download>
              <button class="btn"><i class="bi bi-download"></i></button>
            </a>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- scripts -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.2/dist/js/bootstrap.bundle.min.js"
          integrity="sha384-OERcA2EqjJCMA+/3y+gxIOqMEjwtxJY7qPCqsdltbNJuaOe923+mo//f6V8Qbsw3"
          crossorigin="anonymous"></script>
  <script async defer src="https://apis.google.com/js/api.js" onload="gapiLoaded()"></script>
  <script async defer src="https://accounts.google.com/gsi/client" onload="gisLoaded()"></script>
</body>
</html>

<!DOCTYPE html>
<html>
<head>
  <title>Google Drive Gallery</title>
  <meta charset="utf-8">

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.2/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-Zenh87qX5JnK2Jl0vWa8Ck2rdkQ2Bzep5IDxbcnCeuOxjzrPF/et3URy9Bv1WTRi" crossorigin="anonymous">

  <style>
      @media screen {
          .main-container {
              width: 60%;
              /* border-radius: 0.5%; */
              padding: 5px;
              margin-top: 5px;
          }
      }
  </style>

  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
  
  <script type="text/javascript">
    window.onerror = function(error) {
      alert("window error..." + error );
    }
  </script>

  <script type="text/javascript">
    const CACHE_DEBUG_MODE = "debugMode";

    // Quick start: https://developers.google.com/drive/api/quickstart/js
    // File list: https://developers.google.com/drive/api/v3/reference/files/list
    
    const CLIENT_ID="1015092151085-osb88kjq9jtmve4hv2bisa0ugda4iun0.apps.googleusercontent.com";
    const API_KEY="AIzaSyC-AjutFl4UADerP1ybHDY3CGvHyUnJKSA";
    //const API_KEY="AIzaSyCKIA6PZIy_6Y92eISUn7XyIFk_DxRFBEQ";

    // Discovery doc URL for APIs used by the quickstart
    const DISCOVERY_DOC = 'https://www.googleapis.com/discovery/v1/apis/drive/v3/rest';

    // Authorization scopes required by the API; multiple scopes can be included, separated by spaces.
    const SCOPES = 'https://www.googleapis.com/auth/drive.metadata.readonly';

    let tokenClient;
    let gapiInited = false;
    let gisInited = false;

    /**
     * Callback after api.js is loaded.
     */
    function gapiLoaded() {
      gapi.load('client', initializeGapiClient);
    }

    /**
     * Callback after the API client is loaded. Loads the
     * discovery doc to initialize the API.
     */
    async function initializeGapiClient() {
      await gapi.client.init({
        apiKey: API_KEY,
        discoveryDocs: [DISCOVERY_DOC],
      });
      gapiInited = true;
      initUi();
    }

    /**
     * Callback after Google Identity Services are loaded.
     */
    function gisLoaded() {
      tokenClient = google.accounts.oauth2.initTokenClient({
        client_id: CLIENT_ID,
        scope: SCOPES,
        callback: '', // defined later
      });
      gisInited = true;
      initUi();
    }

    function initUi() {
      if (!gapiInited || !gisInited) {
        return; // not ready
      }

      $('#debugMode').prop('checked', localStorage.getItem(CACHE_DEBUG_MODE) !== false);
    }

    /**
     *  Sign in the user upon button click.
     */
    function handleAuthClick() {
      debugAlert("authClicked");

      try {
        tokenClient.callback = async (resp) => {
          if (resp.error !== undefined) {
            throw (resp);
          }
          document.getElementById('authorize_button').innerText = 'Refresh';
          await listFiles();
        };

        if (gapi.client.getToken() === null) {
          // Prompt the user to select a Google Account and ask for consent to share their data
          // when establishing a new session.
          tokenClient.requestAccessToken({prompt: 'consent'});
        } else {
          // Skip display of account chooser and consent dialog for an existing session.
          tokenClient.requestAccessToken({prompt: ''});
        }
      } catch (err) {
        handleError(err);
      }
    }

    /**
     *  Sign out the user upon button click.
     */
    function handleSignoutClick() {
      debugAlert('signout');

      const token = gapi.client.getToken();
      if (token !== null) {
        google.accounts.oauth2.revoke(token.access_token);
        gapi.client.setToken('');
        $('#content').html('');
        document.getElementById('authorize_button').innerText = 'Authorize';
      }
    }

    /**
     * Print metadata for first 10 files.
     */
    async function listFiles() {
      hideError();

      try {
        let files = await getFileList();
        debugAlert(typeof files);

        if (!files || files.length == 0) {
          $('#content').html('No files');
          return;
        }

        let output = files.map(JSON.stringify).join('<br/>');
        $('#content').html(output);

        // let thumbnails = files.map((file) => getFileInfo(file.id)).join('<br/>');
        let thumbnails = files.map((file) => getThumbnailLink()).join('<br/>');
        $('#content').html($('#content').html() + thumbnails);
      } catch (err) {
        handleError(err);
      }
    }

    async function getFileList() {
      //         response = await gapi.client.drive.files.list({
//           'pageSize': 10,
//           'fields': 'files(id, name)',
//         });
        
      // default fields: id, name, and mimeType
      let response = await gapi.client.drive.files.list({
        q: "'1eHo-uOU1LTHQKFJhhd8BpMwiF81NTYmk' in parents", // link ID
        fields: "nextPageToken, files(id,name,createdTime,modifiedTime,size,hasThumbnail,thumbnailLink,webViewLink)",
        pageSize: 3
      });

      debugAlert(response);
      return response.result.files;
    }

    async function getFileInfo(id) {
      try {
        let response = await gapi.client.drive.files.get({
          fileId: id,
          fields: "thumbnailLink,contentHints"
        });

        debugAlert(response);
        return response.thumbnailLink;
      } catch (err) {
        handleError(err);
      }
    }
 
    function getThumbnailLink(id) {
      return "https://drive.google.com/thumbnail?authuser=0&sz=w320&id=" + id;
    }

    function handleError(err) {
      try {
        $('#error').html(JSON.stringify(err) + "<br/>");
      } catch (err) {
        $('#error').html(err.message);
      }
      showError();
    }

    function showError() {
      $('#error').show();
    }

    function hideError() {
      $('#error').hide();
    }

    function debugAlert(message) {
      if (!isDebugModeEnabled()) {
        return; // debug mode is disabled
      }

      try {
        alert(typeof message === "string" ? message : JSON.stringify(message));
      } catch (err) {
        alert("Not able to parse message: " + message);
      }
    }

    function storeDebugMode() {
      localStorage.setItem(CACHE_DEBUG_MODE, isDebugModeEnabled());
    }
    
    function isDebugModeEnabled() {
      return $('#debugMode').is(':checked');
    }
  </script>
</head>
<body>
  <button id="authorize_button" onclick="handleAuthClick()">Authorize</button>
  <button id="signout_button" class="action-button" onclick="handleSignoutClick()">Sign Out</button>
  <button class="action-button" onclick="listFiles()">List Files</button>
  <button class="action-button" onclick="getFileInfo(prompt('Input file.id'))">Get File Info</button>
  <input id="debugMode" type="checkbox" onchange="storeDebugMode()" onchange="storeDebugMode" checked>Debug
  version: 7

  <div id="error" class="alert alert-danger" role="alert" hidden></div>

  <div id="content" class="alert alert-info" role="alert"></div>

  <script async defer src="https://apis.google.com/js/api.js" onload="gapiLoaded()"></script>
  <script async defer src="https://accounts.google.com/gsi/client" onload="gisLoaded()"></script>
</body>
</html>
